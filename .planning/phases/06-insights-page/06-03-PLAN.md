---
phase: 06-insights-page
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified:
  - app/insights/page.tsx
  - app/insights/InsightsDashboard.tsx
  - app/insights/InsightsCharts.tsx
  - src/lib/insights/format.ts
  - src/lib/insights/export.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "User can navigate to /insights and see a polished, professional dashboard (not a placeholder page)."
    - "User can see KPI totals (recordings, minutes, transcribed minutes, coverage %, language distribution)."
    - "User can see charts showing trends and usage patterns over time."
    - "User can export an insights report file (JSON) via a save dialog."
  artifacts:
    - path: "app/insights/page.tsx"
      provides: "Insights route wired to dashboard"
    - path: "app/insights/InsightsDashboard.tsx"
      provides: "Client dashboard that loads insights payload and renders states"
    - path: "app/insights/InsightsCharts.tsx"
      provides: "Recharts visualizations with explicit sizing"
    - path: "src/lib/insights/export.ts"
      provides: "Insights report export using existing Tauri save_export pipeline"
  key_links:
    - from: "app/insights/InsightsDashboard.tsx"
      to: "src/lib/insights/commands.ts"
      via: "getLibraryInsights()"
      pattern: "getLibraryInsights\("
    - from: "app/insights/InsightsDashboard.tsx"
      to: "src/lib/fs/config.ts"
      via: "getLastFolder + getAllTranscriptionMeta"
      pattern: "getLastFolder|getAllTranscriptionMeta"
---

<objective>
Build the Insights page UI: a professional dashboard with KPI cards, Recharts charts, and report export.

Purpose: Deliver INSIGHTS-01/02/03 by replacing the placeholder insights page with a real dashboard powered by the aggregated insights payload.
Output: `/insights` route with dashboard UI, charts, export action, and robust empty/loading/error states.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/insights/page.tsx
@app/library/page.tsx
@src/lib/fs/config.ts
@src/lib/insights/commands.ts
@src/lib/transcription/export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Recharts dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
Install Recharts (chart library) as a dependency:

- Run: `npm install recharts`

Do not introduce other chart libraries.
  </action>
  <verify>`npm ls recharts` shows `recharts@^3.3.0` (or compatible) installed.</verify>
  <done>Recharts is available for use in client components.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Insights dashboard page + data loading</name>
  <files>app/insights/page.tsx, app/insights/InsightsDashboard.tsx, src/lib/insights/format.ts</files>
  <action>
Replace the placeholder Insights page with a dashboard layout and data loading.

`app/insights/page.tsx`:
- Keep it minimal; render `<InsightsDashboard />`.

`app/insights/InsightsDashboard.tsx` (new, must be a Client Component):
- Load `lastFolder` using `getLastFolder()`.
- If no folder is set:
  - Render a strong empty state (title, explanation) and a CTA button linking to `/library`.
- If folder exists:
  - Load transcription metadata map via `getAllTranscriptionMeta()`.
  - Call `getLibraryInsights({ folderPath: lastFolder, preset, transcriptionMetaByPath: meta })`.
  - Provide a time range UI (segmented control): 7d / 30d / 90d / all; default to `30d`.
  - Show loading skeletons while fetching and show an error state if the invoke fails.

Visual direction (match existing app styling):
- Use the existing `bg-slate-deep` / `border-slate-border` / `text-slate-*` palette.
- Use a 12-col grid rhythm:
  - Top bar: title + subtitle + range control + export button.
  - KPI row: 4 cards.
  - Charts: 2x2 grid on lg, stacked on mobile.
- Ensure each chart container has explicit height (`h-56`, `h-72`) to avoid Recharts rendering 0px.

`src/lib/insights/format.ts` (new):
- Add small pure helpers used by UI only:
  - `formatMinutes(seconds: number): string` (1 decimal ok)
  - `formatPct(pct: number): string`
  - `formatDayLabel(dayStartUnix: number, preset: InsightsRangePreset): string` (uses `new Date(dayStartUnix*1000)`)

Do not add SSR-only code; everything is client-side.
  </action>
  <verify>`npm run build` succeeds and visiting `/insights` no longer shows the "Coming Soon" placeholder.</verify>
  <done>Insights page loads data for the last scanned folder and renders KPI cards + dashboard layout with correct states.</done>
</task>

<task type="auto">
  <name>Task 3: Add charts + export report</name>
  <files>app/insights/InsightsCharts.tsx, src/lib/insights/export.ts, app/insights/InsightsDashboard.tsx</files>
  <action>
Add chart rendering and an export action.

`app/insights/InsightsCharts.tsx` (new, Client Component):
- Accept `payload: LibraryInsightsPayload` and derived labels as props.
- Render at least:
  1) Trend chart (Area/Line): recording minutes per day + transcribed minutes per day (2 series).
  2) Bar chart: duration bucket counts.
  3) Pie/Donut chart: language distribution (use `'unknown'` label when needed).
- Use `ResponsiveContainer` with an explicit-height parent container.

`src/lib/insights/export.ts` (new):
- Implement `exportInsightsReport(payload: LibraryInsightsPayload): Promise<void>`.
- Output JSON (pretty-printed) and reuse the existing save pipeline from `src/lib/transcription/export.ts`:
  - Use the same dialog pattern + `invoke('save_export', { path, content })`.
- Filename suggestion: `open-recorder-insights-{preset}.json`.

`app/insights/InsightsDashboard.tsx`:
- Add an "Export report" button in the top bar that calls `exportInsightsReport(payload)`.

Do not implement advanced interactions (tooltips/filters are fine if Recharts provides them, but no custom filtering UI).
  </action>
  <verify>
Build: `npm run build` succeeds.
Manual smoke: run `npm run tauri:dev`, open Insights, verify charts render and export saves a JSON file.
  </verify>
  <done>Insights page shows charts and can export a JSON report via dialog.</done>
</task>

</tasks>

<verification>
- Recharts components render (no 0-height issues).
- Insights page gracefully handles: no folder, loading, error, and normal data.
- Export uses the same `save_export` pipeline as transcript export.
</verification>

<success_criteria>
- INSIGHTS-01: `/insights` shows a professional dashboard UI (no placeholder).
- INSIGHTS-02: dashboard includes trend charts showing usage patterns.
- INSIGHTS-03: KPI row and language distribution are visible.
</success_criteria>

<output>
After completion, create `.planning/phases/06-insights-page/06-03-SUMMARY.md`
</output>
